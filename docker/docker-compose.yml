services:
  suricata:
    container_name: suricata
    image: agnusdei1207/suricata:latest
    network_mode: host
    cap_add:
      - SYS_NICE
      - NET_ADMIN
    volumes:
      - suricata-log:/var/log/suricata
      - suricata-config:/etc/suricata:rw
      - suricata-rules:/var/lib/suricata/rules:rw
    command:
      - "-c"
      - "/etc/suricata/suricata.yaml"
      - "-i"
      - "eth0"
      - "--af-packet"
      - "--runmode=autofp"
      - "--set=af-packet.0.copy-mode=ips"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  fluent-bit:
    container_name: fluent-bit
    image: agnusdei1207/fluent-bit:latest
    volumes:
      - suricata-log:/var/log/suricata:ro
      - fluentbit-volume:/fluent-bit/log
    depends_on:
      suricata:
        condition: service_started
    networks:
      - bastion-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  axum:
    container_name: axum
    image: agnusdei1207/axum:latest
    restart: unless-stopped
    depends_on:
      fluent-bit:
        condition: service_started
    volumes:
      - axum-volume:/logs
      - /var/run/docker.sock:/var/run/docker.sock
      - suricata-rules:/var/lib/suricata/rules:rw
    environment:
      # API
      - API_SERVER_URL=http://localhost:8000
      - CENTRAL_API_SERVER_URL=https://api.bastion/api
      # Suricata
      - SURICATA_RULES_DIR=/var/lib/suricata/rules
      - SURICATA_CUSTOM_RULE_FILENAME=custom.rules
      - SURICATA_LOG_DIR=/var/log/suricata
      - SURICATA_LOG_FILE=/var/log/suricata/eve.json
    ports:
      - "3000:3000"
    networks:
      - bastion-network
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

volumes:
  suricata-log:
    driver: local
  suricata-config:
    driver: local
  suricata-rules:
    driver: local
  fluentbit-volume:
    driver: local
  axum-volume:
    driver: local

networks:
  bastion-network:
    driver: bridge
    attachable: true
